#pragma once
#include <string>
#include <string_view>
#include <stdexcept>
#include <curl/curl.h>
#include <nlohmann/json.hpp>

namespace ghupdate {

static size_t write_callback(void* contents, size_t size, size_t nmemb, void* userp) {
    size_t total = size * nmemb;
    static_cast<std::string*>(userp)->append((char*)contents, total);
    return total;
}

inline std::string http_get(std::string_view url) {
    CURL* curl = curl_easy_init();
    if (!curl) throw std::runtime_error("curl init failed");

    std::string buffer;

    curl_easy_setopt(curl, CURLOPT_URL, url.data());
    curl_easy_setopt(curl, CURLOPT_USERAGENT, "C++23-update-checker");
    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, write_callback);
    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &buffer);

    CURLcode res = curl_easy_perform(curl);
    curl_easy_cleanup(curl);

    if (res != CURLE_OK)
        throw std::runtime_error("HTTP request failed");

    return buffer;
}

struct UpdateInfo {
    bool hasUpdate;
    std::string latestVersion;
};

inline int version_to_int(std::string_view v) {
    // sehr einfache Normalisierung: 1.2.3 â†’ 001002003
    int major = 0, minor = 0, patch = 0;
    sscanf(v.data(), "%d.%d.%d", &major, &minor, &patch);
    return major * 1'000'000 + minor * 1'000 + patch;
}

inline UpdateInfo check_github_update(std::string_view repoApiUrl, std::string_view localVersion) {
    // repoApiUrl muss sein:
    // "https://api.github.com/repos/OWNER/REPO/releases/latest"

    std::string jsonText = http_get(repoApiUrl);

    auto json = nlohmann::json::parse(jsonText);
    std::string latest = json["tag_name"].get<std::string>();

    bool update = version_to_int(latest) > version_to_int(localVersion);

    return { update, latest };
}

} // namespace ghupdate
