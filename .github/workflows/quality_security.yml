name: C++ Quality & Security

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget pipx cmake ninja-build build-essential gcc-14 g++-14 libssl-dev libcurl4-openssl-dev git

      - name: Build with CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-14 -DCMAKE_CXX_COMPILER=g++-14
          cmake --build build --parallel

      - name: Analyze
        uses: github/codeql-action/analyze@v4

  cppcheck:
    name: Cppcheck Static Analysis
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck jq

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev wget pipx cmake ninja-build build-essential gcc-14 g++-14 libssl-dev

      - name: Configure CMake (generate compile_commands.json)
        run: |
          cmake -S . -B build-cppcheck -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cp build-cppcheck/compile_commands.json . 2>/dev/null || true

      - name: Debug - Check compile_commands.json
        run: |
          echo "=== compile_commands.json exists ==="
          if [ -f compile_commands.json ]; then
            ls -lah compile_commands.json
            echo "=== Total entries in compile_commands.json ==="
            jq 'length' compile_commands.json
            echo "=== Files in compile_commands.json ==="
            jq -r '.[].file' compile_commands.json | sort -u
          else
            echo "compile_commands.json not found, will use direct file paths"
          fi

      - name: Filter compile_commands.json (only project files, skip _deps)
        run: |
          echo "=== Filtering compile_commands.json ==="

          if [ -f compile_commands.json ]; then
            # Filter out _deps and keep only cli/, include/, tests/
            jq '[.[] | select(.file | contains("_deps") | not)]' compile_commands.json > compile_commands_filtered.json
            
            echo "=== Original entries ==="
            jq 'length' compile_commands.json
            
            echo "=== Filtered entries (excluding _deps) ==="
            jq 'length' compile_commands_filtered.json
            
            echo "=== Files to analyze ==="
            jq -r '.[].file' compile_commands_filtered.json | sort -u
            
            mv compile_commands_filtered.json compile_commands.json
          fi

      - name: Run Cppcheck
        shell: bash
        run: |
          echo "=== Starting Cppcheck Analysis ==="

          if [ -f compile_commands.json ] && [ "$(jq 'length' compile_commands.json)" -gt 0 ]; then
            echo "Using compile_commands.json for analysis"
            cppcheck \
              --enable=all \
              --inconclusive \
              --std=c++23 \
              --project=compile_commands.json \
              --error-exitcode=0 \
              --report-progress \
              2>&1 | tee cppcheck-report.txt
          else
            echo "compile_commands.json is empty or missing, using direct file paths"
            cppcheck \
              --enable=all \
              --inconclusive \
              --std=c++23 \
              --error-exitcode=0 \
              --report-progress \
              cli/ include/ tests/ \
              2>&1 | tee cppcheck-report.txt
          fi

          echo "=== Cppcheck Analysis Complete ==="
          echo "=== Report Statistics ==="
          LINES=$(wc -l < cppcheck-report.txt)
          echo "Report has $LINES lines"

          if [ "$LINES" -gt 0 ]; then
            echo "=== Sample Output (first 30 lines) ==="
            head -30 cppcheck-report.txt
          else
            echo "âœ… Analysis completed with no issues found"
          fi

      - name: Upload Cppcheck Report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

  cvecheck:
    name: Generate CVE-Report
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: echo "version=1.0.0" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev wget pipx cmake ninja-build build-essential gcc-14 g++-14 libssl-dev

      - name: Configure CMake (export compile_commands)
        run: |
          cmake -S . -B build \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          cmake --build build --config Release

      - name: Setup Python (fÃ¼r reuse)
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Node.js v24
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install SBOM Tools
        run: |
          pip install reuse
          # npm install -g @appthreat/atom
          npm install -g @cyclonedx/cdxgen
          wget https://github.com/AppThreat/atom/releases/download/v2.5.2/atom.zip
          unzip atom.zip

      - name: Prepare Output Directory
        run: mkdir -p docs

      - name: Generate SPDX SBOM
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Generating SPDX SBOM with version: $version"
          reuse spdx -o "./docs/spdx-${version}.spdx" || { echo "SPDX generation failed"; exit 1; }

          if [ -f "./docs/spdx-${version}.spdx" ]; then
            echo "âœ… SPDX SBOM created"
            ls -lah "./docs/spdx-${version}.spdx"
          else
            echo "âš ï¸  SPDX SBOM not created (this may be OK if REUSE is not configured)"
          fi

      - name: Run Atom Analysis
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Running Atom analysis with version: $version"

          if [ -d "./bin" ]; then
            ./bin/atom -J-Xmx16g usages -o ./docs/app.atom --slice-outfile "./docs/atom-${version}.json" -l cpp build/ || {
              echo "âš ï¸  Atom analysis failed, continuing..."
            }
          else
            echo "âš ï¸  Atom binary not found, skipping Atom analysis"
          fi

          # Check if atom file exists or create empty one
          if [ ! -f "./docs/atom-${version}.json" ]; then
            echo "Creating placeholder atom file since generation failed or was skipped"
            mkdir -p docs
            echo '{"slices": []}' > "./docs/atom-${version}.json"
          fi

      - name: Generate CycloneDX SBOM (build-aware)
        env:
          FETCH_LICENSE: true
          CDXGEN_COMPILE_COMMANDS_FILE: build/compile_commands.json
        run: |
          version="${{ steps.version.outputs.version }}"
          echo "Generating SBOM with version: $version"

          cdxgen \
            --output "docs/cyclonedx-${version}.json" \
            --output-format json \
            --spec-version 1.6 \
            -t cpp \
            --usages-slices-file "docs/atom-${version}.json" \
            --deep \
            --recurse \
            --project-name "CheckForGHUpdate" \
            --project-group "io.github.zbamtarikh" \
            --project-version "${version}" \
            --author "ZHENG Robert" \
            . || { echo "cdxgen error: $?"; exit 1; }

          echo "=== Checking if SBOM file was created ==="
          if [ -f "docs/cyclonedx-${version}.json" ]; then
            echo "âœ… SBOM file created successfully"
            ls -lah "docs/cyclonedx-${version}.json"
            wc -c "docs/cyclonedx-${version}.json"
          else
            echo "âŒ SBOM file not created!"
            ls -la docs/
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install cve-bin-tool
        run: pipx install cve-bin-tool

      - name: Debug - Check SBOM file before CVE scan
        run: |
          echo "=== Checking SBOM file ==="
          if [ -f "./docs/cyclonedx-${{ steps.version.outputs.version }}.json" ]; then
            ls -lah "./docs/cyclonedx-${{ steps.version.outputs.version }}.json"
            echo "=== SBOM file size and content preview ==="
            wc -c "./docs/cyclonedx-${{ steps.version.outputs.version }}.json"
            echo "--- First 100 lines ---"
            head -100 "./docs/cyclonedx-${{ steps.version.outputs.version }}.json"
          else
            echo "ERROR: SBOM file not found!"
            exit 1
          fi

      - name: CVE Report (CVSS >= 9 - Critical Only)
        run: |
          echo "=== Scanning for CRITICAL CVEs (CVSS >= 9) ==="
          cve-bin-tool --sbom cyclonedx --sbom-file ./docs/cyclonedx-${{ steps.version.outputs.version }}.json \
            --format json \
            --output cve-report-critical-${{ steps.version.outputs.version }}.json \
            --disable-data-source OSV,EPSS \
            --cvss 9 || true

          echo "=== CRITICAL CVEs Report Generated ==="
          if [ -f "cve-report-critical-${{ steps.version.outputs.version }}.json" ]; then
            SIZE=$(wc -c < "cve-report-critical-${{ steps.version.outputs.version }}.json")
            echo "Report file size: $SIZE bytes"
            
            if [ "$SIZE" -gt 10 ]; then
              echo "âš ï¸  CRITICAL CVEs FOUND!"
              cat "cve-report-critical-${{ steps.version.outputs.version }}.json"
            else
              echo "âœ… No critical CVEs found (CVSS >= 9)"
            fi
          fi

      - name: CVE Report (All Vulnerabilities - Informational)
        run: |
          echo "=== Scanning for ALL CVEs ==="
          cve-bin-tool --sbom cyclonedx --sbom-file ./docs/cyclonedx-${{ steps.version.outputs.version }}.json \
            --format json \
            --output cve-report-all-${{ steps.version.outputs.version }}.json \
            --disable-data-source OSV,EPSS \
            --cvss 0 || true

          echo "=== ALL CVEs Report Generated ==="
          if [ -f "cve-report-all-${{ steps.version.outputs.version }}.json" ]; then
            SIZE=$(wc -c < "cve-report-all-${{ steps.version.outputs.version }}.json")
            echo "Report file size: $SIZE bytes"
            
            if [ "$SIZE" -gt 10 ]; then
              echo "ðŸ“Š Summary of all vulnerabilities:"
              # Extract CVE count if possible
              grep -o '"vulnerability"' "cve-report-all-${{ steps.version.outputs.version }}.json" | wc -l || echo "Unable to count CVEs"
            else
              echo "âœ… No vulnerabilities found at any level"
            fi
          fi

      - name: Create CVE Summary Report
        run: |
          echo "=== CVE SCAN SUMMARY ===" > cve-summary.txt
          echo "" >> cve-summary.txt
          echo "Scan Date: $(date)" >> cve-summary.txt
          echo "SBOM File: ./docs/cyclonedx-${{ steps.version.outputs.version }}.json" >> cve-summary.txt
          echo "" >> cve-summary.txt

          echo "CRITICAL VULNERABILITIES (CVSS >= 9):" >> cve-summary.txt
          if [ -f "cve-report-critical-${{ steps.version.outputs.version }}.json" ]; then
            SIZE=$(wc -c < "cve-report-critical-${{ steps.version.outputs.version }}.json")
            if [ "$SIZE" -gt 10 ]; then
              echo "âš ï¸  Found - see cve-report-critical-${{ steps.version.outputs.version }}.json" >> cve-summary.txt
            else
              echo "âœ… None found" >> cve-summary.txt
            fi
          fi

          echo "" >> cve-summary.txt
          echo "ALL VULNERABILITIES (CVSS >= 0):" >> cve-summary.txt
          if [ -f "cve-report-all-${{ steps.version.outputs.version }}.json" ]; then
            SIZE=$(wc -c < "cve-report-all-${{ steps.version.outputs.version }}.json")
            if [ "$SIZE" -gt 10 ]; then
              echo "Found - see cve-report-all-${{ steps.version.outputs.version }}.json" >> cve-summary.txt
            else
              echo "âœ… None found" >> cve-summary.txt
            fi
          fi

          cat cve-summary.txt

      - name: Upload CVE Report and SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cve-report
          path: |
            ./cve-report-critical-${{ steps.version.outputs.version }}.json
            ./cve-report-all-${{ steps.version.outputs.version }}.json
            ./cve-summary.txt
            ./docs/cyclonedx-${{ steps.version.outputs.version }}.json
            ./docs/spdx-${{ steps.version.outputs.version }}.spdx

      - name: Commit SBOM files to repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if docs directory exists and files were generated
          if [ -d docs ] && [ -f "docs/spdx-${{ steps.version.outputs.version }}.spdx" ] && [ -f "docs/cyclonedx-${{ steps.version.outputs.version }}.json" ]; then
            git add docs/spdx-${{ steps.version.outputs.version }}.spdx
            git add docs/cyclonedx-${{ steps.version.outputs.version }}.json
            git commit -m "chore: update SBOM artifacts for version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
            git push
          else
            echo "SBOM files not found in docs directory"
          fi

  clang_tidy:
    name: Clang-Tidy Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Clang & Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy nlohmann-json3-dev \
            libcurl4-openssl-dev wget pipx cmake ninja-build build-essential \
            gcc-14 g++-14 libboost-dev libboost-system-dev libboost-date-time-dev \
            libboost-regex-dev libboost-test-dev libssl-dev libsqlite3-dev

      - name: Configure CMake (export compile_commands.json)
        run: |
          cmake -S . -B build-clangtidy \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_STANDARD=23
          cp build-clangtidy/compile_commands.json .

      - name: Debug - Check compile_commands.json
        run: |
          echo "=== compile_commands.json exists ==="
          ls -lah compile_commands.json || echo "File not found!"
          echo "=== compile_commands.json content (first 30 lines) ==="
          head -30 compile_commands.json
          echo "=== Files to analyze ==="
          jq -r '.[].file' compile_commands.json 2>/dev/null | head -10

      - name: Run Clang-Tidy
        shell: bash
        run: |
          echo "=== Starting Clang-Tidy Analysis ==="

          # Get list of source files from compile_commands.json
          FILES=$(jq -r '.[].file' build-clangtidy/compile_commands.json 2>/dev/null | sort -u)

          if [ -z "$FILES" ]; then
            echo "ERROR: No files found in compile_commands.json"
            exit 1
          fi

          echo "Files to analyze:"
          echo "$FILES"

          # Run clang-tidy on each file
          echo "$FILES" | xargs clang-tidy -p build-clangtidy --quiet 2>&1 | tee clang-tidy-report.txt || true

          echo "=== Clang-Tidy Analysis Complete ==="
          echo "=== Report Statistics ==="
          LINES=$(wc -l < clang-tidy-report.txt)
          echo "Total lines in report: $LINES"

          if [ "$LINES" -eq 0 ]; then
            echo "No issues found (or report is empty)"
          else
            echo "=== Issues Found ==="
            head -20 clang-tidy-report.txt
          fi

      - name: Upload Clang-Tidy Report
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-report
          path: clang-tidy-report.txt

  release:
    name: Create Release with SBOM & Changelog
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [codeql, cppcheck, clang_tidy]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Check SBOM files exist
        run: |
          echo "Checking for SBOM files..."
          ls -lah docs/spdx-${{ steps.version.outputs.version }}.spdx || echo "SPDX SBOM not found"
          ls -lah docs/cyclonedx-${{ steps.version.outputs.version }}.json || echo "CycloneDX SBOM not found"

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy SBOM files if they exist
          if [ -f "docs/spdx-${{ steps.version.outputs.version }}.spdx" ]; then
            cp docs/spdx-${{ steps.version.outputs.version }}.spdx release-assets/
            echo "âœ“ Copied SPDX SBOM"
          fi

          if [ -f "docs/cyclonedx-${{ steps.version.outputs.version }}.json" ]; then
            cp docs/cyclonedx-${{ steps.version.outputs.version }}.json release-assets/
            echo "âœ“ Copied CycloneDX SBOM"
          fi

          # Copy CVE Reports
          if [ -f "cve-report-critical-${{ steps.version.outputs.version }}.json" ]; then
            cp cve-report-critical-${{ steps.version.outputs.version }}.json release-assets/
            echo "âœ“ Copied CVE Report (Critical)"
          fi

          if [ -f "cve-report-all-${{ steps.version.outputs.version }}.json" ]; then
            cp cve-report-all-${{ steps.version.outputs.version }}.json release-assets/
            echo "âœ“ Copied CVE Report (All)"
          fi

          if [ -f "cve-summary.txt" ]; then
            cp cve-summary.txt release-assets/
            echo "âœ“ Copied CVE Summary"
          fi

          if [ -z "$VERSION_SECTION" ]; then
            VERSION_SECTION=$(sed -n "/## \[${{ steps.version.outputs.version }}\]/,\$p" CHANGELOG.md)
          fi

          # Save to file for use in release
          echo "$VERSION_SECTION" > release_notes.txt
          echo "Release notes extracted from CHANGELOG.md"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release v${{ steps.version.outputs.version }}"
          body_path: release_notes.txt
          draft: false
          prerelease: false
          files: |
            release-assets/CHANGELOG.md
            release-assets/spdx-${{ steps.version.outputs.version }}.spdx
            release-assets/cyclonedx-${{ steps.version.outputs.version }}.json
            release-assets/cve-report-critical-${{ steps.version.outputs.version }}.json
            release-assets/cve-report-all-${{ steps.version.outputs.version }}.json
            release-assets/cve-summary.txt
